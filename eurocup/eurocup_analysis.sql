with orders as (
    SELECT order_id
    FROM delta.central_order_descriptors_odp.order_descriptors_v2
    WHERE store_id IN (424532,326824,66266,91447,356466,51061,64938,61034,56175,205021,440815,46992,365870,136586,344573,288575,310653,392789,345143,51477,91537,57851,57916,105092,371572,60043,409928,51223,183556,396973,241821,389174,376600,202944,427167,60812,421987,392874,264893,52802,326840,53110,436038,427298,406339,53338,59577,53111,302912,59580,313394,413458,59224,271531,137313,219013,229322,413977,430296,423065,60637,419534,437267,411948,401997,418522,401054,405513,285882,171484,51062,367676,268945,89144,447955,109965,153683,299623,310601,229955,433944,415179,397240,398528,453688,454016,98840,389217,389198,408491,449783,451792,59977,450569,402650,59712,58009,55779,56917,455972,74798,395867,351250,73483,380448,397250,186392,73895,353890,372569,453978,456638,438231,55363,420956,299732,310600,80277,83559,168051,83267,447072,54264,351279,54456,452793,434570,451831,451380,364089,90553,70719,259266,444800,356685,435282,456476,400206,345119,345079,345038,54293,399425,447147,411023,411048,411050,354230,415933,59894,54289,395522,380455,406181,396441,62472,425920,61377,344990,311856,394498,61960,302910,447221,59579,369066,403230,417526,223583,60710,83900,437968,272128,385597,128649,299542,86652,61523,77437,252287,86981,368184,86973,85070,104235,95692,421640,71952,231301,405745,406598,399683,443711,434941,401433,446250,51078,61064,221897,420372,60173,56173,374063,438354,332261,62983,323913,416535,413298,413103,347175,324341,92836,453581,429291,58962,60416,434006,425090,249019,422608,437244,451455,146446,91783,91129,91193,433942,79073,436975,438828,119407,425099,78712,351926,81179,77489,337168,323802,456151,135276,123335,90772,47040,446268,85381,92500,332022,330795,449809,72547,431285,97342,82283,426657,84303,81247,435165,396269,313652,448901,457969,450011,317850,434474,449979,457735,322733,78530,379626,352564,428707,417562,429914,235157,235377,438380,451442,342737,343210,421192,344261,137683,145973,401602,431641,441563,391068,89728,111900,409413,409393,409404,409429,409358,409414,123876,98316,392747,82303,270945,303924,74780,88009,149382,159543,127972,115238,301168,121903,60995,69764,412145,453743,457881,123948,425094,427238,449647,424998,425234,427928,425170,425276,274335,135616,58252,430743,270319,271428,425030,425209,65240,425359,60633,60634,280288,55788,56916,215367,82566,135799,51187,163486,60335,91683,264841,52794,323451,58318,257104,60302,91771,365146,60663,301440,46921,144120,54229,123955,265834,280767,447069,347053,215435,135811,83426,89771,273944,93668,440955,77376,257217,128078,361687,336688,89738,274378,301475,89752,425368,58067,298438,414856,390863,373320,364068,457447,447266,364530,447131,366562,62569,358286,295072,295247,337701,235295,357810,260696,430684,75497,221921,416635,73076,51073,52895,54455,59524,61381,75386,80935,100835,103247,107536,111749,113273,354048,375907,91478,113628,113641,90898,86648,136196,113653,91461,116678,116675,91504,136150,136935,113657,59231,93977,121875,113679,137115,281883,136180,93981,59138,48911,46914,111926,111934,136096,137118,112577,191304,136199,327818,112569,112575,136190,142427,142594,142645,242826,142690,156190,365743,60087,142667,142707,317149,143021,309910,142653,313264,156135,212091,143378,243038,278061,243015,142647,344446,212180,182324,242774,156166,212368,242862,302795,336065,427344,212100,325371,243055,60264,278539,316224,378600,325364,302751,142659,325298,434110,378602,397246,363376,397262,397260,47125,107773,109903,59980,82398,59985,82096,60022,60009,52767,55621,91513,60012,60001,60025,59890,51228,67446,81766,99758,99790,98807,90221,99616,99767,90222,99620,341765,98802,117220,331428,99621,99612,100502,99748,100163,98458,64633,77091,77063,77071,57376,77086,153807,145097,85016,89464,77097,199396,77059,77080,357701,357689,353711,345167,374503,339296,342605,339485,330590,330496,330422,317278,310396,310429,310241,310308,302788,302431,287053,247730,286426,77078,77122,273251,93434,270251,77089,375913,374425,77101,247710,77090,222317,241170,222277,213701,213633,209151,97124,206525,206568,206502,199442,189949,97101,165036,161424,153839,145082,145088,85019,107993,132450,120228,77105,77102,97114,97113,77096,77093,85018,77110,435200,328817,443442,430462,120645,106902,89390,59578,52735,51241,46927,440597,56898,81293,391092,353570,268449,100472,391071,280779,81298,216147,406169,114062,81255,81289,136401,397997,353896,268462,386171,136407,406582,358193,280783,136404,216153,406776,136411,136394,136400,159479,447721,361066,453985,198634,165867,47100,47055,47057,395747,123904,123896,127389,123902,438451,440754,123899,415953,127396,127445,440781,444171,310269,62235,64904,62239,60835,62244,77359,74220,101078,391946,82657,99182,61952,100831,108716,64910,105357,300427,100818,123113,78045,106039,123120,106040,106042,106043,123152,123131,398718,428970,123106,421755,452742,296133,54584,259171,330558,442380,453709,376933,366353,269825,93750,182453,85724,441242,49893,114510,328351,459274,55725,51714,434177,95907,458657,453520,425357,51370)
      AND (date_trunc('day', order_started_local_at)) >= (DATE '2024-06-01')
      AND (date_trunc('day', order_started_local_at)) <= (DATE '2024-08-30')
      AND order_final_status = 'DeliveredStatus'
      AND order_parent_relationship_type IS NULL
),
obiadek_promocode_orders as (
    SELECT
        order_id
    FROM
        delta.growth_discounts_odp.discounts_promocode_uses a
    FULL OUTER JOIN
        delta.growth_pricing_discounts_odp.pricing_discounts b
        ON a.promocode_id = b.promocode_id
        AND a.promocode_uses_id = b.promocode_use_id
    WHERE
        a.promocode_id IN (2615170513, 2597604350)
),
orders_with_products_discount as (
    SELECT
        distinct (order_id)
    FROM
        delta.growth_pricing_discounts_odp.pricing_discounts
    WHERE
        discount_on_products_eur <> 0.0
        AND p_creation_date > date '2024-04-01'
),
orders_without_obiadek as (
    select * from orders
    except
    select * from obiadek_promocode_orders
),
orders_without_obiadek_and_product_discounts as (
    select * from orders_without_obiadek
    except
    select * from orders_with_products_discount
)
SELECT date_format(order_started_local_at,'%Y-%m-%d') as day,
       count(order_id) as orders,
       AVG(contribution_margin_eur) AS avg_cm,
       AVG(TCOREV_eur) as TCOREV_eur,
       AVG(TOTBDR_eur) as TOTBDR_eur,
       AVG(MBSRSU_eur) as MBSRSU_eur,
       AVG(BWSREV_eur) as BWSREV_eur,
       AVG(DEACSU_eur) as DEACSU_eur,
       AVG(ADVE_eur) as ADVE_eur,
       AVG(SERFIG_eur) as SERFIG_eur,
       AVG(MFCGSO_eur) as MFCGSO_eur,
       AVG(QMCOGS_eur) as QMCOGS_eur,
       AVG(CPOBIF_eur) as CPOBIF_eur,
       AVG(INHD_eur) as INHD_eur,
       AVG(FGRC_eur) as FGRC_eur,
       AVG(MESH_eur) as MESH_eur,
       AVG(OTMR_eur) as OTMR_eur,
       AVG(SOFT_eur) as SOFT_eur,
       AVG(WASTAG_eur) as WASTAG_eur,
       AVG(CRCARE_eur) as CRCARE_eur,
       AVG(RECOOK_eur) as RECOOK_eur,
       AVG(RECOOC_eur) as RECOOC_eur,
       AVG(ASBYPA_eur) as ASBYPA_eur,
       AVG(OVHE_eur) as OVHE_eur,
       AVG(MFCL_eur) as MFCL_eur,
       AVG(MFMC_eur) as MFMC_eur,
       AVG(PAYFEE_eur) as PAYFEE_eur,
       AVG(CUSPEC_eur) as CUSPEC_eur,
       AVG(CUSNOC_eur) as CUSNOC_eur,
       AVG(FSUBDF_eur) as FSUBDF_eur,
       AVG(GROSUF_eur) as GROSUF_eur,
       AVG(NGRSUF_eur) as NGRSUF_eur,
       AVG(CONSUF_eur) as CONSUF_eur,
       AVG(MFCSUF_eur) as MFCSUF_eur,
       AVG(FOPICK_eur) as FOPICK_eur,
       AVG(F2DDRM_eur) as F2DDRM_eur,
       AVG(GRODDM_eur) as GRODDM_eur,
       AVG(CODDDM_eur) as CODDDM_eur,
       AVG(NGRDDM_eur) as NGRDDM_eur,
       AVG(MFCDDM_eur) as MFCDDM_eur,
       AVG(CRCCRA_eur) as CRCCRA_eur,
       AVG(CRCCRB_eur) as CRCCRB_eur,
       AVG(CRCCRC_eur) as CRCCRC_eur,
       AVG(CACPRG_eur) as CACPRG_eur,
       AVG(CACPRP_eur) as CACPRP_eur,
       AVG(CRCPMP_eur) as CRCPMP_eur,
       AVG(CRCPMM_eur) as CRCPMM_eur,
       AVG(MFCMKT_eur) as MFCMKT_eur,
       AVG(BWSMKT_eur) as BWSMKT_eur
FROM delta.finance_financial_reports_odp.pnl_order_level
WHERE order_id IN (SELECT * FROM orders_without_obiadek_and_product_discounts)
AND p_creation_date > date '2024-04-01'
GROUP BY 1
ORDER BY 1 DESC